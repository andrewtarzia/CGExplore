name: Tests
on:
    push:
        branches:
            - main
    pull_request:
    workflow_dispatch:
jobs:
    ruff:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
            - uses: actions/setup-python@v5
              with:
                  python-version-file: "pyproject.toml"
            - run: uv sync --all-extras --dev
            - run: uv run ruff check src/ tests/ docs/source/ first_paper_example/

    mypy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
            - uses: actions/setup-python@v5
              with:
                  python-version-file: "pyproject.toml"
            - run: uv sync --all-extras --dev
            - run: uv run mypy src/ tests docs/source/_static/recipes

    ruff-format:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
            - uses: actions/setup-python@v5
              with:
                  python-version-file: "pyproject.toml"
            - run: uv sync --all-extras --dev
            - run: uv run ruff format --check src/ tests/ docs/source/ first_paper_example/

    pytest:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
            - uses: actions/setup-python@v5
              with:
                  python-version-file: "pyproject.toml"
            - run: uv sync --all-extras --dev
            - run: uv run pytest

    doctest:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
            - uses: actions/setup-python@v5
              with:
                  python-version-file: "pyproject.toml"
            - run: uv sync --all-extras --dev
            - run: uv run make -C docs doctest

    build-test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
            - uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
            - uses: actions/setup-python@v5
              with:
                  python-version-file: "pyproject.toml"
            - run: uv sync --all-extras --dev

            - name: Clone repo
              run: git clone https://github.com/andrewtarzia/cg_model_test --depth 1

            - name: Run script
              run: uv run python cg_model_test/cg_model_test.py cg_model_test

            - name: Run parameteriser script
              run: uv run python cg_model_test/openmm_parametizer.py cg_model_test

            - uses: actions/upload-artifact@v4
              with:
                  name: parity-plot
                  path: parity.png

            - uses: actions/upload-artifact@v4
              with:
                  name: l1-plot
                  path: l1.png

            - uses: actions/upload-artifact@v4
              with:
                  name: l3-plot
                  path: l3.png

            - uses: actions/upload-artifact@v4
              with:
                  name: l4-plot
                  path: l4.png

            - uses: actions/upload-artifact@v4
              with:
                  name: l5-plot
                  path: l5.png

            - uses: actions/upload-artifact@v4
              with:
                  name: uff-plot
                  path: uff_angle_test.png

            - uses: actions/upload-artifact@v4
              with:
                  name: uff2-plot
                  path: uff_angle_test2.png

            - uses: actions/upload-artifact@v4
              with:
                  name: rt-plot
                  path: random_test.png
